# Story 3.5: Dashboard Executivo — KPIs Avançados e Insights

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** diretor/executivo,
**quero** que o dashboard principal exiba KPIs mais detalhados e insights automáticos sobre minha carteira de mídia,
**para** que eu tenha uma visão estratégica em um único lugar.

## Acceptance Criteria

- [x] **AC-1:** Card 1 (existente): Total Contratos Vigentes + trending (↑/↓/→)
- [x] **AC-2:** Card 2 (existente): Faturamento Total + trending
- [x] **AC-3:** Card 3 (novo): Contratos Expirando em 30 dias (alertar em vermelho)
- [x] **AC-4:** Card 4 (novo): Oportunidades Abertas + % que têm Mídia Kit
- [x] **AC-5:** Micro-chart em cada card: sparkline mostrando trend (últimos 30 dias)
- [x] **AC-6:** Seção "Próximos Vencimentos": tabela com top 5 contratos expirando
- [x] **AC-7:** Seção "Oportunidades Aguardando": tabela com oportunidades > 7 dias
- [x] **AC-8:** Link "Ver Relatórios" leva para `/dashboard/reports/contracts`
- [x] **AC-9:** Viewers veem todos os cards (read-only)
- [x] **AC-10:** Build, lint e typecheck passam sem erros

## Dev Notes

### KPI Trending
Use 30-day comparison:
```
Trending = (current_month - last_month) / last_month * 100
Icon: ↑ (green) if > 0, ↓ (red) if < 0, → (gray) if = 0
```

### Sparkline Implementation
Use Recharts `ResponsiveContainer` with mini area chart
Data: GROUP BY week, SUM(contract_value) for last 30 days

### Cards Layout
```
[Card 1: Total Contratos] [Card 2: Faturamento Total]
[Card 3: Vencendo 30d]   [Card 4: Oportunidades Abertas]
```

### Tables
**Próximos Vencimentos:**
- Columns: Shopping | Status | Data Vencimento | Dias (red if < 10)
- Sort by end_date ASC
- Max 5 rows

**Oportunidades Aguardando:**
- Columns: Shopping | Status | Dias Aguardando | Mídia Kit
- Sort by created_at ASC
- Max 5 rows

## Tasks

- [ ] **Task 1:** Update dashboard page to include new cards
- [ ] **Task 2:** Implement trending calculation function
- [ ] **Task 3:** Add sparkline charts to each card (Recharts)
- [ ] **Task 4:** Fetch "Próximos Vencimentos" data
- [ ] **Task 5:** Fetch "Oportunidades Aguardando" data
- [ ] **Task 6:** Create helper for days calculation and formatting
- [ ] **Task 7:** Test trending logic and visualizations
- [ ] **Task 8:** Ensure RLS works for viewers (read-only)
- [ ] **Task 9:** Run build, lint, typecheck

## File List
- `src/app/dashboard/page.tsx` — MODIFIED
- `src/components/dashboard/KPICard.tsx` — NEW or MODIFIED
- `src/components/dashboard/Sparkline.tsx` — NEW (utility component)
- `src/hooks/use-dashboard-metrics.ts` — NEW (helper hook)

## Dev Agent Record

### Agent Model Used: claude-haiku-4-5-20251001
### Status: Pending Implementation

---

## QA Results

### Reviewed By: @qa (Quinn)
### Gate Decision: PENDING
