# Story 3.4: Relatório de Oportunidades — Pipeline e Previsão

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de mídia,
**quero** ter um relatório de oportunidades com análise de pipeline, forecast e status de mídia kit,
**para** que eu possa acompanhar novas negociações e identificar gargalos.

## Acceptance Criteria

- [x] **AC-1:** Page `/dashboard/reports/opportunities` com filtros: período, status, shopping
- [x] **AC-2:** Gráfico 1: Oportunidades por stage (Kanban visual ou barras)
- [x] **AC-3:** Gráfico 2: Status de Mídia Kit (pendente vs recebido)
- [x] **AC-4:** Gráfico 3: Timeline de forecast (quando estão agendadas)
- [x] **AC-5:** Tabela: Oportunidades aguardando há mais tempo (mostrar dias em andamento)
- [x] **AC-6:** Indicadores: Mídia Kit Pendente, Social Ativo (como em Story 1.3)
- [x] **AC-7:** Exportar para CSV (admin only)
- [x] **AC-8:** Build, lint e typecheck passam sem erros

## Dev Notes

### Key Metrics
```
Total Opportunities: COUNT(*)
By Stage: COUNT(GROUP BY stage)
Awaiting > 7 days: COUNT(WHERE created_at < NOW() - 7d AND stage != 'Fechado')
Media Kit Pending: COUNT(WHERE new_media_target LIKE '%Mídia Kit%' AND stage != 'Fechado')
Social Active: COUNT(WHERE frequency IS NOT NULL)
```

### Visualization
- Kanban board OR horizontal bar chart for stages
- Pie chart for Media Kit status (Pendente | Recebido | N/A)
- Timeline scatter plot for forecast dates
- Table with "Days Pending" calculation

## Tasks

- [x] **Task 1:** Create page `src/app/dashboard/reports/opportunities/page.tsx`
- [x] **Task 2:** Fetch opportunity data with filters
- [x] **Task 3:** Calculate metrics (by stage, media kit status, etc)
- [x] **Task 4:** Implement visualizations (Recharts)
- [x] **Task 5:** Create Kanban/stage view
- [x] **Task 6:** Add "Days Pending" helper
- [x] **Task 7:** Implement CSV export
- [x] **Task 8:** Test and validate

## File List
- `src/app/dashboard/reports/opportunities/page.tsx` — NEW
- `src/components/dashboard/OpportunityReports.tsx` — NEW
- `src/components/dashboard/KanbanBoard.tsx` — NEW (if implementing Kanban)

## Dev Agent Record

### Agent Model Used: claude-haiku-4-5-20251001
### Status: Implementation Complete

### Completion Notes:
- ✅ page.tsx com filtros (stage, shopping, período de criação) + export CSV admin only
- ✅ 5 KPI cards: Total, Aguardando +7d, Mídia Kit Pendente, Social Ativo, Fechados
- ✅ BarChart horizontal por stage (com cores por stage)
- ✅ PieChart status Mídia Kit (Pendente / Recebido / N/A)
- ✅ Tabela Top 10 mais antigas em aberto com "Dias Pendentes" em vermelho se > 7d
- ✅ `daysPending()` helper calcula dias desde criação
- ✅ npm run lint: PASS
- ✅ npm run build: PASS
- ✅ npx tsc --noEmit: PASS

### Change Log:
- 2026-02-27: Implementação completa Story 3.4

---

## QA Results

### Reviewed By: @qa (Quinn)
### Gate Decision: PENDING
