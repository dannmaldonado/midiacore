# Story 1.2: Contract Form Enhancement — Novos Campos na UI

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @architect
- **quality_gate_tools:** [npm run build, npm run lint]

## Story

**Como** gestor de mídia da Lojas Torra,
**quero** visualizar e editar todos os campos de um contrato (tipo de negociação, propriedades de mídia, documentos, layouts, orçamentos pendentes e comentários),
**para** ter controle completo das informações do contrato sem precisar consultar a planilha.

## Acceptance Criteria

- [x] **AC-1:** Formulário de novo contrato (`/dashboard/contracts/new`) contém todos os campos do PRD FR-001
- [x] **AC-2:** Formulário de edição (`/dashboard/contracts/[id]`) contém todos os campos e pré-preenche com dados existentes
- [x] **AC-3:** Campo `media_properties` permite adicionar/remover múltiplas mídias (lista dinâmica ou input com tags)
- [x] **AC-4:** Campos `contract_docs` e `layouts_url` são exibidos como links clicáveis quando preenchidos
- [x] **AC-5:** Listagem de contratos exibe badge amarelo "Orçamento Pendente" quando `pending_quotes` está preenchido
- [x] **AC-6:** Listagem exibe ícone de link para `layouts_url` quando preenchido
- [x] **AC-7:** Formulários salvam e atualizam corretamente no Supabase incluindo os novos campos
- [x] **AC-8:** `npm run build` e `npm run lint` passam sem erros

## Dev Notes

### Dependência
- **Bloqueante:** Story 1.1 deve estar completa (migration aplicada + types atualizados)

### Contexto Arquitetural
- PRD: `docs/prd/midiacore-prd.md` → FR-001
- Arquitetura: `docs/architecture/brownfield-architecture.md` → Seção 12.2

### Padrões de UI a Seguir
Baseado no código existente em `src/app/dashboard/contracts/new/page.tsx` e `[id]/page.tsx`:
- Classes de input: `pl-4 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-4 focus:ring-indigo-500/10`
- Labels: `text-[10px] font-black text-slate-400 uppercase tracking-widest`
- Cards de seção: `executive-card`
- Botão primário: `bg-indigo-600 text-white px-6 py-3 rounded-2xl font-black`

### Grupos de Campos no Formulário
Organizar em 5 seções:
1. **Dados do Ativo** → shopping_name, media_type, media_properties
2. **Financeiro & Status** → contract_value, status, pending_quotes
3. **Documentação** → contract_docs (URL), layouts_url (URL)
4. **Cronograma** → start_date, end_date, negotiation
5. **Stakeholder & Notas** → responsible_person, comments

### Input para `media_properties` (TEXT[])
- Usar um input de texto com botão "Adicionar"
- Exibir como tags/chips removíveis
- Ao salvar, converter array de strings para `text[]` do PostgreSQL

### Links Externos
- `contract_docs` e `layouts_url`: exibir como `<a href={url} target="_blank">` com ícone ExternalLink do Lucide

### Badge na Listagem
```tsx
{contract.pending_quotes && (
  <span className="px-2 py-1 bg-amber-50 text-amber-600 border border-amber-100 rounded-lg text-[10px] font-black uppercase">
    Orçamento Pendente
  </span>
)}
```

### Gotchas
- O cliente Supabase no browser é `createClient()` de `@/lib/supabase/client`
- Ao fazer UPDATE, incluir todos os novos campos para evitar sobrescrever com `undefined`
- `media_properties` deve ser salvo como array PostgreSQL: o SDK Supabase aceita `string[]` diretamente
- Campos opcionais vazios devem ser salvos como `null`, não string vazia

## Tasks

- [x] **Task 1: Atualizar formulário de novo contrato**
  - [x] 1.1 Abrir `src/app/dashboard/contracts/new/page.tsx`
  - [x] 1.2 Adicionar campos: `negotiation`, `contract_docs`, `layouts_url`, `pending_quotes`, `comments`
  - [x] 1.3 Implementar input dinâmico para `media_properties` (array)
  - [x] 1.4 Atualizar payload do INSERT para incluir novos campos
  - [x] 1.5 Organizar formulário nas 5 seções documentadas em Dev Notes

- [x] **Task 2: Atualizar formulário de edição**
  - [x] 2.1 Abrir `src/app/dashboard/contracts/[id]/page.tsx`
  - [x] 2.2 Pré-preencher todos os novos campos ao carregar o contrato
  - [x] 2.3 Exibir `contract_docs` e `layouts_url` como links clicáveis acima do input
  - [x] 2.4 Atualizar payload do UPDATE para incluir novos campos

- [x] **Task 3: Atualizar listagem de contratos**
  - [x] 3.1 Abrir `src/app/dashboard/contracts/page.tsx`
  - [x] 3.2 Adicionar badge "Orçamento Pendente" quando `pending_quotes` está preenchido
  - [x] 3.3 Adicionar ícone de link externo para `layouts_url` quando preenchido
  - [x] 3.4 Adicionar coluna "Negociação" na tabela (opcional, em tela larga)

- [x] **Task 4: Verificação**
  - [x] 4.1 Executar `npm run build` sem erros — ✅ PASS (9/9 páginas)
  - [x] 4.2 Executar `npm run lint` sem erros — ✅ PASS (0 errors, 1 warning pré-existente)

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Debug Log References: []
### Completion Notes:
- Formulário new/page.tsx reescrito com 5 seções organizadas + tag input para media_properties
- Formulário [id]/page.tsx reescrito com pre-fill de todos os campos, links clicáveis para contract_docs/layouts_url
- Listagem page.tsx: badge "Orçamento Pendente" (amber), link "Layouts" (indigo), coluna "Negociação" (hidden lg:table-cell)
- colSpan corrigido de 5 → 6 para acomodar nova coluna
- Build: ✅ PASS | Lint: ✅ PASS | TypeScript: ✅ PASS

### File List
- `src/app/dashboard/contracts/new/page.tsx` — MODIFICADO
- `src/app/dashboard/contracts/[id]/page.tsx` — MODIFICADO
- `src/app/dashboard/contracts/page.tsx` — MODIFICADO

### Change Log
| Data | Alteração | Autor |
|------|-----------|-------|
| 2026-02-25 | Story criada | River (SM) |
| 2026-02-25 | Validação @po: GO (9/10) — adicionados executor/@dev, quality_gate/@architect | Pax (PO) |
| 2026-02-25 | Implementação completa — build ✅ lint ✅ | Dex (dev) |
| 2026-02-25 | QA Review completo — CONCERNS | Quinn (qa) |
| 2026-02-25 | Security fix: DELETE + company_id guard — build ✅ lint ✅ | Quinn (qa) |

## QA Results

### Reviewed By: Quinn (@qa)
### Review Date: 2026-02-25
### Gate Decision: CONCERNS

#### AC Verification
| AC | Status | Observação |
|----|--------|------------|
| AC-1 | ✅ PASS | new/page.tsx com 5 seções organizadas e todos os campos do PRD FR-001 |
| AC-2 | ✅ PASS | [id]/page.tsx pré-preenche todos os campos incluindo media_properties (array) |
| AC-3 | ✅ PASS | Tag input com addMediaProp/removeMediaProp, duplicatas prevenidas, chips removíveis |
| AC-4 | ✅ PASS | ExternalLink acima dos inputs contract_docs e layouts_url quando preenchidos |
| AC-5 | ✅ PASS | Badge amber "Orçamento Pendente" na listagem quando pending_quotes preenchido |
| AC-6 | ✅ PASS | Ícone ExternalLink indigo "Layouts" na listagem quando layouts_url preenchido |
| AC-7 | ✅ PASS | UPDATE inclui todos os campos; campos vazios → null corretamente |
| AC-8 | ✅ PASS | Build ✅ Lint ✅ |

#### Security Analysis
- Leituras: `.eq('company_id', profile.company_id)` ✅
- UPDATE: `.eq('id', contractId).eq('company_id', profile.company_id)` ✅
- **CONCERN:** DELETE em `contracts/[id]/page.tsx` (linha 138–139) usa apenas `.eq('id', contractId)` sem filtro `company_id` a nível de aplicação. Mitigado por RLS no banco, mas quebra o padrão de defesa em profundidade.
- rel="noopener noreferrer" nos links externos ✅

#### Issues Found
- **MEDIUM (segurança — defesa em profundidade):** `handleDelete` em `contracts/[id]/page.tsx` não inclui `.eq('company_id', profile.company_id)`. Risco real baixo (RLS protege no DB), mas inconsistente com o padrão adotado no UPDATE do mesmo arquivo. Recomendação: adicionar o filtro na próxima iteração.

#### Gate Decision Rationale
Todos os ACs cobertos corretamente. Concern de segurança é MEDIUM (não bloqueante) — RLS do Supabase mitiga o risco real. Aprovado com registro do issue para correção futura.
