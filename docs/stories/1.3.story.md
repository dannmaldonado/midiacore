# Story 1.3: Opportunities CRUD — Pipeline de Oportunidades

## Status: Approved

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @architect
- **quality_gate_tools:** [npm run build, npm run lint]

## Story

**Como** analista de marketing da Lojas Torra,
**quero** gerenciar o pipeline de oportunidades de mídia por shopping center,
**para** acompanhar o status de negociações de novas mídias, redes sociais e eventos sem depender da planilha.

## Acceptance Criteria

- [ ] **AC-1:** Página `/dashboard/opportunities` lista todas as oportunidades com busca por shopping e filtro por status
- [ ] **AC-2:** Formulário de criação (`/dashboard/opportunities/new`) contém todos os campos do PRD FR-002
- [ ] **AC-3:** Formulário de edição (`/dashboard/opportunities/[id]`) pré-preenche dados existentes e permite exclusão
- [ ] **AC-4:** Badge "Mídia Kit Pendente" aparece quando `new_media_target` contém "Mídia Kit" ou "Aguardando"
- [ ] **AC-5:** Badge "Social Ativo" aparece quando `frequency` está preenchido (indica conteúdo em andamento)
- [ ] **AC-6:** CRUD persiste corretamente no Supabase com isolamento por `company_id`
- [ ] **AC-7:** Empty state visual quando não há oportunidades
- [ ] **AC-8:** `npm run build` e `npm run lint` passam sem erros

## Dev Notes

### Dependência
- **Bloqueante:** Story 1.1 deve estar completa (campos frequency, social_media_plan, new_media_target, events_plan na tabela `opportunities`)

### Contexto Arquitetural
- PRD: `docs/prd/midiacore-prd.md` → FR-002 (inclui tabela com 14 oportunidades reais)
- Arquitetura: `docs/architecture/brownfield-architecture.md` → Seção 12.2

### Estrutura de Páginas a Criar

```
src/app/dashboard/opportunities/
├── page.tsx          # Listagem com filtros
├── new/
│   └── page.tsx      # Formulário de criação
└── [id]/
    └── page.tsx      # Formulário de edição + delete
```

### Padrões a Seguir
- Clonar estrutura de `src/app/dashboard/contracts/page.tsx` como base para a listagem
- Clonar estrutura de `src/app/dashboard/contracts/new/page.tsx` como base para o formulário
- Mesmas classes de estilo (Tailwind + `.executive-card`)
- Auth: usar `useAuth()` hook de `@/hooks/use-auth`
- Supabase: usar `createClient()` de `@/lib/supabase/client`

### Campos do Formulário de Oportunidade
```
1. Shopping → shopping_name (TEXT, obrigatório)
2. Frequência → frequency (select: Diário | Semanal | Mensal | Sob demanda)
3. Plano de Redes Sociais → social_media_plan (textarea)
4. Novas Mídias à Contratar → new_media_target (textarea)
5. Programação de Eventos → events_plan (textarea)
6. Status → stage (TEXT — reutilizar campo existente)
7. Comentários → notes (textarea — campo existente)
```

### Status da Oportunidade (field: `stage`)
Usar os valores já presentes no schema. Sugerir opções:
- `Em negociação`
- `Aguardando resposta`
- `Mídia Kit pendente`
- `Contrato em elaboração`
- `Fechado`

### Badges na Listagem
```tsx
// Badge "Mídia Kit Pendente"
{opp.new_media_target?.toLowerCase().includes('mídia kit') ||
 opp.new_media_target?.toLowerCase().includes('aguardando') ? (
  <span className="badge-amber">Mídia Kit Pendente</span>
) : null}

// Badge "Social Ativo"
{opp.frequency ? (
  <span className="badge-indigo">{opp.frequency}</span>
) : null}
```

### Colunas da Listagem
| Shopping | Frequência | Status | Ações |
Com linha expandível opcional para ver social_media_plan.

### Gotchas
- O campo `stage` já existe na tabela `opportunities` e na interface `Opportunity` — reutilizá-lo para status da oportunidade
- O campo `forecast_date` também existe no schema — pode ser exposto no formulário como "Data prevista"
- A interface `Opportunity` atual tem `title`, `client_name`, `value`, `stage`, `responsible_person` — os campos novos (frequency, etc.) foram adicionados na Story 1.1

## Tasks

- [ ] **Task 1: Criar página de listagem**
  - [ ] 1.1 Criar `src/app/dashboard/opportunities/page.tsx`
  - [ ] 1.2 Implementar fetch de oportunidades por `company_id`
  - [ ] 1.3 Implementar busca por `shopping_name`
  - [ ] 1.4 Implementar filtro por `stage`
  - [ ] 1.5 Implementar badges (Mídia Kit Pendente, Social Ativo)
  - [ ] 1.6 Implementar empty state visual
  - [ ] 1.7 Adicionar botão "Nova Oportunidade" com link para `/new`

- [ ] **Task 2: Criar formulário de nova oportunidade**
  - [ ] 2.1 Criar `src/app/dashboard/opportunities/new/page.tsx`
  - [ ] 2.2 Implementar formulário com todos os campos
  - [ ] 2.3 Implementar SELECT para `frequency` e `stage`
  - [ ] 2.4 Implementar INSERT no Supabase com `company_id` do profile

- [ ] **Task 3: Criar formulário de edição**
  - [ ] 3.1 Criar `src/app/dashboard/opportunities/[id]/page.tsx`
  - [ ] 3.2 Implementar fetch da oportunidade por `id`
  - [ ] 3.3 Pré-preencher todos os campos
  - [ ] 3.4 Implementar UPDATE no Supabase
  - [ ] 3.5 Implementar DELETE com confirmação

- [ ] **Task 4: Verificação**
  - [ ] 4.1 Executar `npm run build` sem erros
  - [ ] 4.2 Executar `npm run lint` sem erros

## Dev Agent Record

### Agent Model Used: -
### Debug Log References: []
### Completion Notes: []

### File List
- `src/app/dashboard/opportunities/page.tsx` — NOVO
- `src/app/dashboard/opportunities/new/page.tsx` — NOVO
- `src/app/dashboard/opportunities/[id]/page.tsx` — NOVO

### Change Log
| Data | Alteração | Autor |
|------|-----------|-------|
| 2026-02-25 | Story criada | River (SM) |
| 2026-02-25 | Validação @po: GO (8/10) — adicionados executor/@dev, quality_gate/@architect | Pax (PO) |
