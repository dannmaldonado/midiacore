# Story 1.4: Contacts CRUD ‚Äî CRM de Contatos por Tipo

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @architect
- **quality_gate_tools:** [npm run build, npm run lint]

## Story

**Como** gestor de m√≠dia da Lojas Torra,
**quero** ter uma lista centralizada de contatos organizada por tipo (Gerentes de Loja internos vs. MKT de Shopping),
**para** encontrar rapidamente o contato certo de cada shopping sem consultar a planilha.

## Acceptance Criteria

- [x] **AC-1:** P√°gina `/dashboard/contacts` exibe contatos em duas abas: "Gerentes de Loja" e "MKT Shopping"
- [x] **AC-2:** Busca funciona por nome, email ou shopping dentro de cada aba
- [x] **AC-3:** Formul√°rio de cria√ß√£o (`/dashboard/contacts/new`) inclui sele√ß√£o de tipo (Gerente / MKT Shopping)
- [x] **AC-4:** Formul√°rio de edi√ß√£o (`/dashboard/contacts/[id]`) pr√©-preenche dados e permite exclus√£o
- [x] **AC-5:** Bot√£o de copiar email e telefone para clipboard (com feedback visual "Copiado!")
- [x] **AC-6:** CRUD persiste corretamente no Supabase com isolamento por `company_id`
- [x] **AC-7:** Empty state quando n√£o h√° contatos na aba ativa
- [x] **AC-8:** `npm run build` e `npm run lint` passam sem erros

## Dev Notes

### Depend√™ncia
- **Bloqueante:** Story 1.1 deve estar completa (campos `contact_type` e `shopping_name` na tabela `contacts`)

### Contexto Arquitetural
- PRD: `docs/prd/midiacore-prd.md` ‚Üí FR-003 (inclui tabela com 44 contatos reais ‚Äî 22 gerentes + 22 MKT)
- Arquitetura: `docs/architecture/brownfield-architecture.md` ‚Üí Se√ß√£o 12.2

### Estrutura de P√°ginas a Criar

```
src/app/dashboard/contacts/
‚îú‚îÄ‚îÄ page.tsx          # Listagem com tabs e busca
‚îú‚îÄ‚îÄ new/
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx      # Formul√°rio de cria√ß√£o
‚îî‚îÄ‚îÄ [id]/
    ‚îî‚îÄ‚îÄ page.tsx      # Formul√°rio de edi√ß√£o + delete
```

### Padr√µes a Seguir
- Mesmas classes de estilo (Tailwind + `.executive-card`)
- Auth: `useAuth()` de `@/hooks/use-auth`
- Supabase: `createClient()` de `@/lib/supabase/client`

### Campos do Formul√°rio de Contato
```
1. Tipo ‚Üí contact_type (radio/select: 'store_manager' | 'shopping_mkt')
2. Shopping ‚Üí shopping_name (TEXT, obrigat√≥rio)
3. Nome ‚Üí name (TEXT, obrigat√≥rio)
4. Cargo/Fun√ß√£o ‚Üí role (TEXT, opcional)
5. Empresa ‚Üí company_name (TEXT, opcional)
6. Telefone ‚Üí phone (TEXT, opcional)
7. Email ‚Üí email (TEXT, opcional)
```

### Tabs de Listagem
```tsx
type TabType = 'store_manager' | 'shopping_mkt'

const tabs = [
  { key: 'store_manager', label: 'Gerentes de Loja' },
  { key: 'shopping_mkt',  label: 'MKT Shopping' },
]
```

Filtrar contatos por `contact_type === activeTab` no client-side ap√≥s carregar todos.

### Bot√£o Copiar (Clipboard API)
```tsx
const copyToClipboard = async (text: string, field: string) => {
  await navigator.clipboard.writeText(text)
  setCopied(field) // estado local
  setTimeout(() => setCopied(null), 2000)
}

// Uso:
<button onClick={() => copyToClipboard(contact.email, `email-${contact.id}`)}>
  {copied === `email-${contact.id}` ? 'Copiado!' : contact.email}
</button>
```

### Layout do Card de Contato
```
[Avatar com iniciais] Nome do Contato
                      Shopping ‚Äî Cargo
                      üìû Telefone [copiar]
                      ‚úâÔ∏è Email [copiar]
```

### Gotchas
- O campo `contact_type` n√£o existe na interface `Contact` atual ‚Äî foi adicionado na Story 1.1
- `navigator.clipboard` requer HTTPS em produ√ß√£o ‚Äî funciona em localhost sem problemas
- A tabela `contacts` j√° tem `company_name` como campo de texto (nome da empresa externa) ‚Äî diferente de `companies` (multi-tenant)
- `shopping_name` foi adicionado na Story 1.1 como campo denormalizado para facilitar queries

## Tasks

- [x] **Task 1: Criar p√°gina de listagem com tabs**
  - [x] 1.1 Criar `src/app/dashboard/contacts/page.tsx`
  - [x] 1.2 Implementar fetch de todos os contatos por `company_id`
  - [x] 1.3 Implementar estado de aba ativa (`store_manager` | `shopping_mkt`)
  - [x] 1.4 Implementar filtro client-side por `contact_type` e busca por nome/shopping/email
  - [x] 1.5 Implementar card de contato com bot√µes de copiar email e telefone
  - [x] 1.6 Implementar feedback visual "Copiado!" com timeout (2s)
  - [x] 1.7 Implementar empty state por aba
  - [x] 1.8 Adicionar bot√£o "Novo Contato" com link para `/new`

- [x] **Task 2: Criar formul√°rio de novo contato**
  - [x] 2.1 Criar `src/app/dashboard/contacts/new/page.tsx`
  - [x] 2.2 Implementar sele√ß√£o de tipo (cards clic√°veis com borda destacada)
  - [x] 2.3 Implementar formul√°rio completo com todos os campos
  - [x] 2.4 Implementar INSERT no Supabase com `company_id` do profile

- [x] **Task 3: Criar formul√°rio de edi√ß√£o**
  - [x] 3.1 Criar `src/app/dashboard/contacts/[id]/page.tsx`
  - [x] 3.2 Implementar fetch do contato por `id`
  - [x] 3.3 Pr√©-preencher todos os campos incluindo `contact_type`
  - [x] 3.4 Implementar UPDATE no Supabase
  - [x] 3.5 Implementar DELETE com confirma√ß√£o

- [x] **Task 4: Verifica√ß√£o**
  - [x] 4.1 Executar `npm run build` sem erros ‚Äî ‚úÖ PASS (13/13 p√°ginas)
  - [x] 4.2 Executar `npm run lint` sem erros ‚Äî ‚úÖ PASS (0 errors, 1 warning pr√©-existente)

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Debug Log References: []
### Completion Notes:
- Grid de cards com avatar de iniciais (gradiente indigo‚Üípurple)
- Tabs "Gerentes de Loja" / "MKT Shopping" com contador por aba
- Clipboard copy com √≠cone Check (emerald) por 2s ao copiar telefone/email
- Sele√ß√£o de tipo com cards clic√°veis (border-2 destacada) no formul√°rio
- Build: ‚úÖ PASS | Lint: ‚úÖ PASS | TypeScript: ‚úÖ PASS

### File List
- `src/app/dashboard/contacts/page.tsx` ‚Äî NOVO
- `src/app/dashboard/contacts/new/page.tsx` ‚Äî NOVO
- `src/app/dashboard/contacts/[id]/page.tsx` ‚Äî NOVO

### Change Log
| Data | Altera√ß√£o | Autor |
|------|-----------|-------|
| 2026-02-25 | Story criada | River (SM) |
| 2026-02-25 | Valida√ß√£o @po: GO (8/10) ‚Äî adicionados executor/@dev, quality_gate/@architect | Pax (PO) |
| 2026-02-25 | Implementa√ß√£o completa ‚Äî build ‚úÖ lint ‚úÖ | Dex (dev) |
