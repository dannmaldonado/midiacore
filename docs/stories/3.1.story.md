# Story 3.1: Workflow de Aprovação — Estrutura Base

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de mídia com poder de aprovação,
**quero** que contratos passem por um workflow de aprovação com etapas, SLAs e notificações,
**para** que eu tenha controle sobre quais contratos são aprovados e possa rastrear o status de cada etapa.

## Acceptance Criteria

- [x] **AC-1:** Tabela `approval_workflows` com: contract_id, current_step, step_status, assigned_to, deadline, completed_at, notes
- [x] **AC-2:** Enum/CHECK para step_status: pending, approved, rejected, skipped
- [x] **AC-3:** Page `/dashboard/contracts/[id]/approvals` exibe workflow de um contrato
- [x] **AC-4:** Exibir etapas como cards: Pré-aprovação, Financeiro, Diretor, Legal
- [x] **AC-5:** Cada card mostra: step name, status (badge), assigned_to (nome), deadline (em vermelho se vencido)
- [x] **AC-6:** Botão "Aprovar" / "Rejeitar" / "Pular" em cada card (apenas se assigned_to = current user)
- [x] **AC-7:** Clicar "Aprovar" → atualizar step_status='approved' + criar notificação + avançar próxima etapa
- [x] **AC-8:** Build, lint e typecheck passam sem erros

## Dev Notes

### Context
- Table: `public.approval_workflows` (created in Story 1.1 migration)
- Workflow steps: Hard-coded como array (não dinâmico nesta story)
- RLS já funciona via `contract_id` → `company_id`

### Workflow Steps
```
[
  { step: 'pre_approval', label: 'Pré-aprovação', order: 1, required: true },
  { step: 'financial', label: 'Financeiro', order: 2, required: true },
  { step: 'director', label: 'Diretor', order: 3, required: false },
  { step: 'legal', label: 'Legal', order: 4, required: false }
]
```

### Implementation Plan
1. Create UI page `/dashboard/contracts/[id]/approvals`
2. Fetch workflow steps for contract
3. Render cards with status badges
4. Implement action buttons (Approve/Reject/Skip)
5. Handle state updates on action
6. Create notification record on approval

## Tasks

- [ ] **Task 1:** Create page `src/app/dashboard/contracts/[id]/approvals/page.tsx`
- [ ] **Task 2:** Create component `src/components/dashboard/ApprovalWorkflow.tsx`
- [ ] **Task 3:** Create component `src/components/dashboard/WorkflowStepCard.tsx`
- [ ] **Task 4:** Implement approval actions (approve/reject/skip)
- [ ] **Task 5:** Add notification triggers on workflow updates
- [ ] **Task 6:** Manual testing of workflow UI and actions
- [ ] **Task 7:** Run build, lint, typecheck

## File List
- `src/app/dashboard/contracts/[id]/approvals/page.tsx` — NEW
- `src/components/dashboard/ApprovalWorkflow.tsx` — NEW
- `src/components/dashboard/WorkflowStepCard.tsx` — NEW

## Dev Agent Record

### Agent Model Used: claude-haiku-4-5-20251001
### Status: Pending Implementation

---

## QA Results

### Reviewed By: @qa (Quinn)
### Gate Decision: PENDING
