# Story 4.4: Etapas com Valores Contratuais

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor financeiro,
**quero** que cada etapa do workflow exiba o valor vinculado ao contrato correspondente,
**para** que eu saiba o valor financeiro em jogo em cada fase de aprovação sem precisar abrir o contrato separadamente.

## Acceptance Criteria

- [ ] **AC-1:** Card de cada etapa em `/dashboard/contracts/[id]/approvals` exibe o `contract_value` do contrato
- [ ] **AC-2:** Tela Prazos (`/dashboard/prazos`) exibe coluna "Valor" por linha de contrato
- [ ] **AC-3:** Valor formatado em BRL: `R$ 12.500,00`
- [ ] **AC-4:** Total acumulado dos contratos em cada etapa exibido no rodapé da seção ou como KPI separado
- [ ] **AC-5:** Campo `contract_value` incluído no fetch de `approval_workflows` (join com `contracts`)
- [ ] **AC-6:** Viewers veem os valores (read-only)
- [ ] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Join Query
```sql
SELECT aw.*, c.shopping_name, c.contract_value, c.end_date
FROM approval_workflows aw
JOIN contracts c ON aw.contract_id = c.id
WHERE c.company_id = get_my_company_id()
```

### Formatação
```ts
const formatBRL = (value: number) =>
  new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value)
```

### KPI Sugerido na Tela Prazos
- "Valor Total em Negociação" = soma de `contract_value` de contratos em etapas ativas
- "Valor em Aprovação Final" = contratos na etapa "Jurídico Torra"

## Tasks

- [ ] **Task 1:** Atualizar query em `use-approval-workflow` (ou hook existente) para incluir `contract_value`
- [ ] **Task 2:** Exibir valor no `WorkflowStepCard.tsx` (Story 3.1)
- [ ] **Task 3:** Adicionar coluna "Valor" na tela Prazos
- [ ] **Task 4:** Implementar total acumulado por etapa
- [ ] **Task 5:** Formatar valores em BRL
- [ ] **Task 6:** Run build, lint, typecheck

## File List
- `src/components/dashboard/WorkflowStepCard.tsx` — MODIFIED
- `src/components/dashboard/ApprovalWorkflow.tsx` — MODIFIED
- `src/components/dashboard/PrazosEtapas.tsx` — MODIFIED (depende da Story 4.2)
- `src/app/dashboard/contracts/[id]/approvals/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: —
### Status: Draft

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
