# Story 4.4: Etapas com Valores Contratuais

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor financeiro,
**quero** que cada etapa do workflow exiba o valor vinculado ao contrato correspondente,
**para** que eu saiba o valor financeiro em jogo em cada fase de aprovação sem precisar abrir o contrato separadamente.

## Acceptance Criteria

- [x] **AC-1:** Card de cada etapa em `/dashboard/contracts/[id]/approvals` exibe o `contract_value` do contrato
- [x] **AC-2:** Tela Prazos (`/dashboard/prazos`) exibe coluna "Valor" por linha de contrato
- [x] **AC-3:** Valor formatado em BRL: `R$ 12.500,00`
- [x] **AC-4:** Total acumulado dos contratos em cada etapa exibido no rodapé da seção ou como KPI separado
- [x] **AC-5:** Campo `contract_value` incluído no fetch de `approval_workflows` (join com `contracts`)
- [x] **AC-6:** Viewers veem os valores (read-only)
- [x] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Join Query
```sql
SELECT aw.*, c.shopping_name, c.contract_value, c.end_date
FROM approval_workflows aw
JOIN contracts c ON aw.contract_id = c.id
WHERE c.company_id = get_my_company_id()
```

### Formatação
```ts
const formatBRL = (value: number) =>
  new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value)
```

### KPI Sugerido na Tela Prazos
- "Valor Total em Negociação" = soma de `contract_value` de contratos em etapas ativas
- "Valor em Aprovação Final" = contratos na etapa "Jurídico Torra"

## Tasks

- [x] **Task 1:** Atualizar query em `use-approval-workflow` (ou hook existente) para incluir `contract_value`
- [x] **Task 2:** Exibir valor no `WorkflowStepCard.tsx` (Story 3.1)
- [x] **Task 3:** Adicionar coluna "Valor" na tela Prazos
- [x] **Task 4:** Implementar total acumulado por etapa
- [x] **Task 5:** Formatar valores em BRL
- [x] **Task 6:** Run build, lint, typecheck

## File List
- `src/components/dashboard/WorkflowStepCard.tsx` — MODIFIED
- `src/components/dashboard/ApprovalWorkflow.tsx` — MODIFIED
- `src/components/dashboard/PrazosEtapas.tsx` — MODIFIED (depende da Story 4.2)
- `src/app/dashboard/contracts/[id]/approvals/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Status: Implementation Complete

### Completion Notes:
- ✅ `WorkflowStepCard.tsx`: prop `contractValue?: number` + seção "Valor do Contrato" formatado em BRL (AC-1)
- ✅ `ApprovalWorkflow.tsx`: prop `contractValue?: number` repassado para cada `WorkflowStepCard`
- ✅ `approvals/page.tsx`: `contract.contract_value` passado para `<ApprovalWorkflow>`
- ✅ `prazos/page.tsx`: coluna "Valor" na tabela (AC-2), KPIs "Valor Total em Negociação" e "Valor em Aprovação Final" (AC-4), rodapé com total acumulado, `formatBRL` com `Intl.NumberFormat` (AC-3)
- ✅ AC-5: contract_value já incluso no `select('*')` dos contratos
- ✅ AC-6: sem restrição de role — viewers veem os valores
- ✅ npm run lint: PASS
- ✅ npx tsc --noEmit: PASS
- ✅ npm run build: PASS

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente
- 2026-02-27: Implementação completa Story 4.4

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
