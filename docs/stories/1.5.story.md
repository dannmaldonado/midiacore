# Story 1.5: Dashboard KPIs Update — Métricas Reais e Enriquecidas

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @architect
- **quality_gate_tools:** [npm run build, npm run lint]

## Story

**Como** diretor ou gestor da Lojas Torra,
**quero** que o Dashboard mostre métricas reais incluindo oportunidades abertas, orçamentos pendentes e dados de ocupação baseados em contratos reais,
**para** ter uma visão executiva precisa do portfólio de mídia sem dados mockados.

## Acceptance Criteria

- [x] **AC-1:** KPI "Oportunidades Abertas" substitui o card "Performance" (que era mockado como 94%) e exibe contagem real de oportunidades ativas
- [x] **AC-2:** Novo KPI "Orçamentos Pendentes" exibe contagem de contratos com campo `pending_quotes` preenchido
- [x] **AC-3:** O gráfico `OccupancyChart` usa dados reais de contratos ativos por mês (baseado em `start_date` e `end_date`) ao invés de valores mockados
- [x] **AC-4:** Dashboard carrega contratos e oportunidades em paralelo (`Promise.all`)
- [x] **AC-5:** Loading states funcionam corretamente para os novos KPIs
- [x] **AC-6:** `npm run build` e `npm run lint` passam sem erros

## Dev Notes

### Dependências
- **Bloqueante:** Story 1.1 (campo `pending_quotes` no schema)
- **Bloqueante:** Story 1.3 (tabela `opportunities` populada para KPI ser útil)

### Contexto Arquitetural
- PRD: `docs/prd/midiacore-prd.md` → FR-005
- Arquitetura: `docs/architecture/brownfield-architecture.md` → Seção 9 (dívida técnica: "dados mockados")

### Arquivo Principal: `src/app/dashboard/page.tsx`
Atualmente:
- Busca apenas `contracts`
- KPI "Performance" é hardcoded como `94%`
- `OccupancyChart` usa `baseValues = [85, 92, 78, 88, 95, 82]` (mock)

### Novo fetch em paralelo
```typescript
const [contractsResult, opportunitiesResult] = await Promise.all([
  supabase.from('contracts').select('*').eq('company_id', profile.company_id),
  supabase.from('opportunities').select('id, stage').eq('company_id', profile.company_id)
])
```

### Novos KPIs
```typescript
// Oportunidades abertas (não fechadas)
const openOpportunities = opportunities.filter(
  o => o.stage !== 'Fechado' && o.stage !== 'closed_won' && o.stage !== 'closed_lost'
).length

// Orçamentos pendentes
const pendingQuotes = contracts.filter(
  c => c.pending_quotes && c.pending_quotes.trim() !== ''
).length
```

### KPIs atualizados (4 cards):
```
1. Contratos Ativos     → stat.active (mantém)
2. Expirando (30d)      → stat.expiring (mantém)
3. Volume de Mídia      → stat.totalValue (mantém)
4. Oportunidades Abertas → openOpportunities (NOVO — substitui Performance mockado)
```

### Novo card adicional (5º card, opcional):
Se o layout suportar 5 cards, adicionar:
```
5. Orçamentos Pendentes → pendingQuotes (NOVO)
```
Caso contrário, manter 4 cards e trocar apenas "Performance" por "Oportunidades Abertas". Documentar a decisão no Change Log.

### Dados reais para OccupancyChart
Calcular contratos ativos por mês nos últimos 6 meses:
```typescript
// Para cada mês dos últimos 6:
// Contar contratos em que start_date <= primeiroDiaMes E end_date >= ultimoDiaMes
const occupancyData = months.map(({ year, month }) => ({
  month: monthLabel,
  value: contracts.filter(c => {
    const start = new Date(c.start_date)
    const end = new Date(c.end_date)
    const monthStart = new Date(year, month, 1)
    const monthEnd = new Date(year, month + 1, 0)
    return start <= monthEnd && end >= monthStart
  }).length
}))
```

### Arquivo: `src/components/dashboard/OccupancyChart.tsx`
- Verificar o tipo de `data` que o componente aceita
- Se o eixo Y estiver fixado em percentual (0-100), ajustar para mostrar contagem absoluta OU manter percentual calculando `(contratos ativos / total contratos) * 100`
- Atualizar label do eixo Y conforme necessário

### Gotchas
- `profile` pode ser null momentaneamente — manter guard `if (!profile?.company_id) return`
- Se não houver oportunidades no banco ainda (após Story 1.3), o KPI mostrará 0 — comportamento correto
- O mock de `OccupancyChart` pode ser `number[]` de 0-100; recalcular como percentual para manter compatibilidade com o componente

## Tasks

- [x] **Task 1: Atualizar fetch do Dashboard**
  - [x] 1.1 Abrir `src/app/dashboard/page.tsx`
  - [x] 1.2 Adicionar import e state para `opportunities`
  - [x] 1.3 Substituir fetch simples por `Promise.all([contracts, opportunities])`
  - [x] 1.4 Calcular `openOpportunities` e `pendingQuotes` no `useMemo` de stats

- [x] **Task 2: Atualizar KPI cards**
  - [x] 2.1 Substituir card "Performance" por "Oportunidades Abertas" com dado real
  - [x] 2.2 Decisão: 5º card "Orçamentos Pendentes" adicionado com grid `sm:grid-cols-2 lg:grid-cols-5`
  - [x] 2.3 Ícones: `TrendingUp` (Oportunidades) + `Target` (Orçamentos Pendentes)

- [x] **Task 3: Atualizar OccupancyChart com dados reais**
  - [x] 3.1 `OccupancyChart` aceita `{ month: string; value: number }[]` — sem alteração no componente
  - [x] 3.2 Cálculo: contratos com start_date <= monthEnd AND end_date >= monthStart
  - [x] 3.3 Substituído `baseValues` mock por dados calculados
  - [x] 3.4 Label do card atualizado para "Contratos Ativos por Mês"

- [x] **Task 4: Verificação**
  - [x] 4.1 Executar `npm run build` sem erros — ✅ PASS (13/13 páginas)
  - [x] 4.2 Executar `npm run lint` sem erros — ✅ PASS (0 errors, 0 warnings)

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Debug Log References: []
### Completion Notes:
- Fix: select('id, stage, pending_quotes') causava erro TS — substituído por select('*')
- Decisão (5º card): adicionado grid lg:grid-cols-5 para acomodar "Orçamentos Pendentes"
- OccupancyChart.tsx não precisou de alteração — componente já é data-agnostic
- Warning pré-existente (Loader2 unused) eliminado ao remover import
- Build: ✅ PASS | Lint: ✅ PASS (0 errors, 0 warnings)

### File List
- `src/app/dashboard/page.tsx` — MODIFICADO

### Change Log
| Data | Alteração | Autor |
|------|-----------|-------|
| 2026-02-25 | Story criada | River (SM) |
| 2026-02-25 | Validação @po: GO (8/10) — adicionados executor/@dev, quality_gate/@architect | Pax (PO) |
| 2026-02-25 | Implementação completa — build ✅ lint ✅ | Dex (dev) |
| 2026-02-25 | QA Review completo — PASS | Quinn (qa) |

## QA Results

### Reviewed By: Quinn (@qa)
### Review Date: 2026-02-25
### Gate Decision: PASS

#### AC Verification
| AC | Status | Observação |
|----|--------|------------|
| AC-1 | ✅ PASS | "Oportunidades Abertas" substitui "Performance 94%" hardcoded |
| AC-2 | ✅ PASS | "Orçamentos Pendentes" conta contratos com pending_quotes não-vazio |
| AC-3 | ✅ PASS | OccupancyChart usa dados reais: `start <= monthEnd && end >= monthStart` |
| AC-4 | ✅ PASS | `Promise.all([contracts, opportunities])` — carregamento paralelo |
| AC-5 | ✅ PASS | Shimmer/pulse para cada KPI e para os dois gráficos |
| AC-6 | ✅ PASS | Build ✅ Lint ✅ (0 errors, 0 warnings — import Loader2 removido) |

#### Logic Verification
- `openOpportunities`: filtra `stage !== 'Fechado' && stage !== 'closed_won' && stage !== 'closed_lost'` — correto para os stage values atuais e defensivo para dados legados ✅
- `pendingQuotes`: `c.pending_quotes && c.pending_quotes.trim() !== ''` — trata null e string vazia ✅
- Cálculo de sobreposição mensal: `start <= monthEnd && end >= monthStart` — matematicamente correto ✅
- Label do mês: `toLocaleDateString('pt-BR', { month: 'short' })` — localização correta ✅

#### Security Analysis
- Ambas as queries usam `.eq('company_id', profile.company_id)` ✅
- Guard `if (!profile?.company_id) return` mantido ✅
- Sem dados sensíveis expostos nos KPIs (apenas contagens) ✅

#### Issues Found
Nenhum issue encontrado.

#### Gate Decision Rationale
Implementação impecável. Dados reais substituem todos os mocks. Lógica de cálculo verificada e correta. Sem issues de segurança. **PASS limpo.**
