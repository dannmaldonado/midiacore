# Story 4.3: Renovação de Contratos — Dashboard e Prazos

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de mídia,
**quero** iniciar um processo de renovação diretamente do dashboard e da tela de prazos,
**para** que eu possa agir rapidamente sobre contratos próximos do vencimento sem precisar navegar manualmente até cada contrato.

## Acceptance Criteria

- [ ] **AC-1:** Dashboard exibe seção/tabela "Contratos para Renovar" com contratos cujo `end_date` está nos próximos **60 dias** (janela de alerta de renovação) — separada do card existente "Expirando em 30 dias"
- [ ] **AC-2:** Clicar "Renovar" abre modal com opções:
  - **Renovação sem Troca de Mídia** → avança direto para etapa 6 do workflow
  - **Renovação com Troca de Mídia** → inicia etapa 7 (SLA 15 dias)
- [ ] **AC-3:** Tela Prazos (`/dashboard/prazos`) destaca em amarelo contratos com `end_date` ≤ 60 dias e exibe botão "Renovar" nesses registros
- [ ] **AC-4:** Ao confirmar renovação, cria novo registro em `approval_workflows` com a etapa de renovação correta e deadline calculado
- [ ] **AC-5:** Contrato atualizado com `current_step` = etapa de renovação escolhida
- [ ] **AC-6:** Notificação gerada para o usuário responsável pela nova etapa
- [ ] **AC-7:** Apenas `admin` pode iniciar renovação; `viewer` vê o status mas não o botão
- [ ] **AC-8:** Build, lint e typecheck passam sem erros

## Dev Notes

### Janela de Alerta de Renovação
- **60 dias** antes do `end_date` → exibir aviso e botão "Renovar"
- Diferença em relação ao card existente (Story 3.5): o card "Expirando em 30 dias" é um KPI de expiração. A renovação é acionada **antes**, com 60 dias de antecedência, para dar tempo ao processo.

```ts
const in60Days = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000)
const renewalCandidates = contracts.filter(c =>
  c.end_date >= today && c.end_date <= in60DaysStr
)
```

### Modal de Renovação
```
Título: "Renovar Contrato — [shopping_name]"
Vencimento atual: [end_date] (faltam X dias)
Opções:
  ○ Renovação sem Troca de Mídia (sem SLA adicional)
  ○ Renovação com Troca de Mídia (15 dias)
Botão: Confirmar Renovação | Cancelar
```

### Fluxo de Dados
1. User clica "Renovar" no card/tabela
2. Modal exibe tipo de renovação
3. Ao confirmar:
   - INSERT `approval_workflows` (contract_id, step = 'renovacao_sem_troca' | 'renovacao_com_troca', step_status = 'pending', deadline = now + sla_days)
   - UPDATE `contracts` SET `current_step` = etapa selecionada
4. Retorna à tela com etapa atualizada

### Migração necessária
- Adicionar coluna `current_step TEXT` na tabela `contracts` (se não existir)

## Tasks

- [ ] **Task 1:** Migração: adicionar `current_step` em `contracts`
- [ ] **Task 2:** Criar componente `RenovacaoModal.tsx`
- [ ] **Task 3:** Criar seção "Contratos para Renovar" no dashboard (filtro 60 dias) com botão "Renovar" por linha
- [ ] **Task 4:** Adicionar botão "Renovar" na tela Prazos (AC-3)
- [ ] **Task 5:** Lógica de INSERT em `approval_workflows` + UPDATE em `contracts`
- [ ] **Task 6:** Integrar notificação (reusar hook `use-notifications.ts`)
- [ ] **Task 7:** Controle de acesso (admin only)
- [ ] **Task 8:** Run build, lint, typecheck

## File List
- `supabase/migrations/YYYYMMDD_add_current_step_to_contracts.sql` — NEW
- `src/components/dashboard/RenovacaoModal.tsx` — NEW
- `src/app/dashboard/page.tsx` — MODIFIED (botão Renovar na tabela)
- `src/app/dashboard/prazos/page.tsx` — MODIFIED (botão Renovar)

## Dev Agent Record

### Agent Model Used: —
### Status: Draft

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente
- 2026-02-27: Janela de alerta de renovação ajustada para **60 dias** (solicitação do cliente)

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
