# Story 1.1: Schema Evolution — Campos Faltantes e Tabela de Aprovação

## Status: Approved

## Executor Assignment
- **executor:** @data-engineer
- **quality_gate:** @dev
- **quality_gate_tools:** [npm run build, npm run lint]

## Story

**Como** gestor de mídia da Lojas Torra,
**quero** que o banco de dados reflita todos os campos necessários para contratos, oportunidades, contatos e fluxo de aprovação,
**para** que as próximas features possam ser implementadas com o schema correto desde o início.

## Acceptance Criteria

- [ ] **AC-1:** Migration SQL cria os novos campos na tabela `contracts` sem quebrar dados existentes
- [ ] **AC-2:** Migration SQL cria os novos campos na tabela `opportunities` sem quebrar dados existentes
- [ ] **AC-3:** Migration SQL adiciona `contact_type` e `shopping_name` na tabela `contacts`
- [ ] **AC-4:** Migration SQL cria a tabela `approval_workflows` com todas as colunas necessárias
- [ ] **AC-5:** RLS policy é criada para a tabela `approval_workflows`
- [ ] **AC-6:** `src/types/index.ts` é atualizado com todas as novas interfaces TypeScript, alinhadas ao schema
- [ ] **AC-7:** Migration é idempotente (usa `IF NOT EXISTS` / `ADD COLUMN IF NOT EXISTS`)

## Dev Notes

### Contexto Arquitetural
- PRD: `docs/prd/midiacore-prd.md` → FR-001 a FR-004
- Arquitetura: `docs/architecture/brownfield-architecture.md` → Seção 12.1
- Migration existente: `supabase/migrations/20260222010000_initial_schema.sql`
- Schema atual em: `src/types/index.ts`

### Padrões a Seguir
- Todas as migrações usam `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`
- RLS pattern: `USING (company_id = public.get_my_company_id())`
- UUIDs como PKs com `gen_random_uuid()`
- Timestamps: `TIMESTAMPTZ DEFAULT now()`
- Arrays PostgreSQL: `TEXT[]` para `media_properties`

### Campos a Adicionar

**`contracts`:**
```sql
negotiation        TEXT          -- Tipo de negociação (ex: Renovação, Negociação Direta)
media_properties   TEXT[]        -- Ex: ['Empena', 'Totem Digital', 'Placa']
contract_docs      TEXT          -- URL do contrato/PI/OS
layouts_url        TEXT          -- Link Google Slides/Drive com layouts
pending_quotes     TEXT          -- Descrição de orçamentos pendentes
comments           TEXT          -- Comentários/observações
```

**`opportunities`:**
```sql
frequency          TEXT          -- Semanal, Mensal, Diário
social_media_plan  TEXT          -- Plano de redes sociais
new_media_target   TEXT          -- Novas mídias à contratar
events_plan        TEXT          -- Programação de eventos
```

**`contacts`:**
```sql
contact_type       TEXT CHECK ('store_manager' | 'shopping_mkt')
shopping_name      TEXT          -- Shopping associado (denormalizado para queries)
```

**Nova tabela `approval_workflows`:**
```sql
id              UUID PK
contract_id     UUID FK → contracts
current_step    TEXT NOT NULL   -- Etapa atual (ver PRD FR-004)
step_status     TEXT NOT NULL CHECK ('pending' | 'approved' | 'rejected' | 'skipped')
assigned_to     UUID FK → profiles NULL
deadline        DATE NULL
completed_at    TIMESTAMPTZ NULL
notes           TEXT NULL
created_at      TIMESTAMPTZ DEFAULT now()
```

### TypeScript — Interfaces a Atualizar/Criar

```typescript
// Contract — adicionar campos
negotiation?: string
media_properties?: string[]
contract_docs?: string | null
layouts_url?: string | null
pending_quotes?: string | null
comments?: string | null

// Opportunity — adicionar campos
frequency?: string | null
social_media_plan?: string | null
new_media_target?: string | null
events_plan?: string | null

// Contact — adicionar campos
contact_type: 'store_manager' | 'shopping_mkt'
shopping_name?: string | null

// Nova interface ApprovalWorkflow
export interface ApprovalWorkflow {
  id: string
  contract_id: string
  current_step: string
  step_status: 'pending' | 'approved' | 'rejected' | 'skipped'
  assigned_to: string | null
  deadline: string | null
  completed_at: string | null
  notes: string | null
  created_at: string
}
```

### Gotchas
- `TEXT[]` no PostgreSQL é um array nativo — no TypeScript mapeia para `string[]`
- O campo `contact_type` não existe na migration inicial — usar `ADD COLUMN IF NOT EXISTS`
- A interface `Profile` em `types/index.ts` tem `full_name` e `avatar_url` que não existem na migration — NÃO corrigir nesta story (está fora do escopo)
- Não há testes automatizados no projeto — validar executando `npm run build`

## Tasks

- [ ] **Task 1: Criar migration SQL**
  - [ ] 1.1 Criar arquivo `supabase/migrations/20260225000000_schema_evolution.sql`
  - [ ] 1.2 Adicionar `ALTER TABLE contracts ADD COLUMN IF NOT EXISTS` para cada campo novo
  - [ ] 1.3 Adicionar `ALTER TABLE opportunities ADD COLUMN IF NOT EXISTS` para cada campo novo
  - [ ] 1.4 Adicionar `ALTER TABLE contacts ADD COLUMN IF NOT EXISTS contact_type` e `shopping_name`
  - [ ] 1.5 Criar tabela `approval_workflows` com `CREATE TABLE IF NOT EXISTS`
  - [ ] 1.6 Criar RLS policy para `approval_workflows`
  - [ ] 1.7 Adicionar CHECK constraint para `contact_type`

- [ ] **Task 2: Atualizar TypeScript types**
  - [ ] 2.1 Abrir `src/types/index.ts`
  - [ ] 2.2 Adicionar campos opcionais na interface `Contract`
  - [ ] 2.3 Adicionar campos opcionais na interface `Opportunity`
  - [ ] 2.4 Adicionar `contact_type` e `shopping_name` na interface `Contact` (criar se não existir)
  - [ ] 2.5 Criar interface `ApprovalWorkflow`

- [ ] **Task 3: Verificação**
  - [ ] 3.1 Executar `npm run build` para confirmar que TypeScript compila sem erros
  - [ ] 3.2 Executar `npm run lint` para confirmar sem erros de lint

## Dev Agent Record

### Agent Model Used: -
### Debug Log References: []
### Completion Notes: []

### File List
- `supabase/migrations/20260225000000_schema_evolution.sql` — NOVO
- `src/types/index.ts` — MODIFICADO

### Change Log
| Data | Alteração | Autor |
|------|-----------|-------|
| 2026-02-25 | Story criada | River (SM) |
| 2026-02-25 | Validação @po: GO (9/10) — adicionados executor/@data-engineer, quality_gate/@dev | Pax (PO) |
