# Story 4.5: Card de Contrato Editável por Etapa Vigente

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de contratos,
**quero** um card/frame editável no detalhe do contrato que mude dinamicamente conforme a etapa vigente,
**para** que eu veja e edite apenas os campos relevantes para a fase atual do processo — sem precisar percorrer todo o formulário.

## Acceptance Criteria

- [x] **AC-1:** Em `/dashboard/contracts/[id]`, novo card "Etapa Vigente" exibe a etapa atual do workflow
- [x] **AC-2:** Cada etapa exibe campos editáveis específicos conforme mapeamento abaixo
- [x] **AC-3:** Campos fora da etapa vigente ficam visíveis mas desabilitados (read-only)
- [x] **AC-4:** Botão "Salvar" persiste alterações no contrato via Supabase
- [x] **AC-5:** Badge da etapa vigente com cor por status: pending=cinza, approved=verde, rejected=vermelho
- [x] **AC-6:** Apenas `admin` pode editar; `viewer` vê o card em modo read-only
- [x] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Mapeamento Etapa → Campos Editáveis
```ts
const ETAPA_CAMPOS: Record<string, string[]> = {
  proposta_solicitacao:    ['shopping_name', 'new_media_target'],
  proposta_mkt:            ['shopping_name', 'new_media_target', 'contract_docs'],
  analise_audi:            ['contract_value', 'contract_docs', 'layouts_url'],
  aprovacao_mkt_torra:     ['contract_docs', 'pending_quotes'],
  juridico_torra:          ['contract_docs', 'contract_value'],
  renovacao_sem_troca:     ['end_date', 'contract_docs'],
  renovacao_com_troca:     ['end_date', 'new_media_target', 'layouts_url'],
  orcamento_producao:      ['pending_quotes', 'contract_value'],
  producao_instalacao:     ['layouts_url', 'media_properties'],
  checking_instalacao:     ['layouts_url', 'contract_docs'],
  renovacao_nao_autorizada:['contract_docs'],
  retirada_midias:         ['end_date', 'contract_docs'],
}
```

### Componente
- Nome: `EtapaVigenteCard`
- Props: `contract: Contract`, `currentStep: string`, `isAdmin: boolean`
- Renderiza campos como `<input>` habilitado se step ativo, `<span>` se inativo
- Persiste via `supabase.from('contracts').update({...}).eq('id', contract.id)`

### Integração
- `current_step` vem de `contracts.current_step` (adicionado na Story 4.3)
- Fallback: ler de `approval_workflows` o step com status 'pending' mais recente

## Tasks

- [x] **Task 1:** Criar componente `EtapaVigenteCard.tsx`
- [x] **Task 2:** Mapear etapas para campos editáveis (conforme Dev Notes)
- [x] **Task 3:** Implementar lógica de habilitação/desabilitação por etapa
- [x] **Task 4:** Adicionar `EtapaVigenteCard` em `/dashboard/contracts/[id]/page.tsx`
- [x] **Task 5:** Persistir edições via Supabase
- [x] **Task 6:** Controle de acesso (admin edit / viewer read)
- [x] **Task 7:** Run build, lint, typecheck

## File List
- `src/components/dashboard/EtapaVigenteCard.tsx` — NEW
- `src/app/dashboard/contracts/[id]/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Status: Implementation Complete

### Completion Notes:
- ✅ `EtapaVigenteCard.tsx`: ETAPA_CAMPOS mapeamento completo (12 etapas), campos habilitados/desabilitados por etapa, badge de status com cores (AC-5), botão "Salvar Etapa" admin-only (AC-6), feedback de sucesso inline
- ✅ `contracts/[id]/page.tsx`: estado `contract` e `currentWorkflow` adicionados; fetch do workflow pendente mais recente; `EtapaVigenteCard` renderizado antes do formulário principal com `key` para remontagem dinâmica
- ⚠️ `new_media_target` omitido: campo não existe no schema de `contracts` — excluído do ETAPA_CAMPOS; etapas que o usavam receberam os demais campos
- ✅ npm run lint: PASS
- ✅ npx tsc --noEmit: PASS
- ✅ npm run build: PASS

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente
- 2026-02-27: Implementação completa Story 4.5

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
