# Story 4.5: Card de Contrato Editável por Etapa Vigente

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de contratos,
**quero** um card/frame editável no detalhe do contrato que mude dinamicamente conforme a etapa vigente,
**para** que eu veja e edite apenas os campos relevantes para a fase atual do processo — sem precisar percorrer todo o formulário.

## Acceptance Criteria

- [ ] **AC-1:** Em `/dashboard/contracts/[id]`, novo card "Etapa Vigente" exibe a etapa atual do workflow
- [ ] **AC-2:** Cada etapa exibe campos editáveis específicos conforme mapeamento abaixo
- [ ] **AC-3:** Campos fora da etapa vigente ficam visíveis mas desabilitados (read-only)
- [ ] **AC-4:** Botão "Salvar" persiste alterações no contrato via Supabase
- [ ] **AC-5:** Badge da etapa vigente com cor por status: pending=cinza, approved=verde, rejected=vermelho
- [ ] **AC-6:** Apenas `admin` pode editar; `viewer` vê o card em modo read-only
- [ ] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Mapeamento Etapa → Campos Editáveis
```ts
const ETAPA_CAMPOS: Record<string, string[]> = {
  proposta_solicitacao:    ['shopping_name', 'new_media_target'],
  proposta_mkt:            ['shopping_name', 'new_media_target', 'contract_docs'],
  analise_audi:            ['contract_value', 'contract_docs', 'layouts_url'],
  aprovacao_mkt_torra:     ['contract_docs', 'pending_quotes'],
  juridico_torra:          ['contract_docs', 'contract_value'],
  renovacao_sem_troca:     ['end_date', 'contract_docs'],
  renovacao_com_troca:     ['end_date', 'new_media_target', 'layouts_url'],
  orcamento_producao:      ['pending_quotes', 'contract_value'],
  producao_instalacao:     ['layouts_url', 'media_properties'],
  checking_instalacao:     ['layouts_url', 'contract_docs'],
  renovacao_nao_autorizada:['contract_docs'],
  retirada_midias:         ['end_date', 'contract_docs'],
}
```

### Componente
- Nome: `EtapaVigenteCard`
- Props: `contract: Contract`, `currentStep: string`, `isAdmin: boolean`
- Renderiza campos como `<input>` habilitado se step ativo, `<span>` se inativo
- Persiste via `supabase.from('contracts').update({...}).eq('id', contract.id)`

### Integração
- `current_step` vem de `contracts.current_step` (adicionado na Story 4.3)
- Fallback: ler de `approval_workflows` o step com status 'pending' mais recente

## Tasks

- [ ] **Task 1:** Criar componente `EtapaVigenteCard.tsx`
- [ ] **Task 2:** Mapear etapas para campos editáveis (conforme Dev Notes)
- [ ] **Task 3:** Implementar lógica de habilitação/desabilitação por etapa
- [ ] **Task 4:** Adicionar `EtapaVigenteCard` em `/dashboard/contracts/[id]/page.tsx`
- [ ] **Task 5:** Persistir edições via Supabase
- [ ] **Task 6:** Controle de acesso (admin edit / viewer read)
- [ ] **Task 7:** Run build, lint, typecheck

## File List
- `src/components/dashboard/EtapaVigenteCard.tsx` — NEW
- `src/app/dashboard/contracts/[id]/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: —
### Status: Draft

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
