# Story 4.7: Contatos — Lista Unificada e Exportação

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de relacionamento,
**quero** ver todos os contatos em uma lista unificada (gerentes de loja + MKT shopping) e poder exportá-los em CSV,
**para** facilitar comunicação em massa, envio de propostas e controle de relacionamento com shoppings.

## Acceptance Criteria

- [x] **AC-1:** `/dashboard/contacts` exibe lista única com todos os contatos (ambos os tipos: `store_manager` e `shopping_mkt`)
- [x] **AC-2:** Lista mostra colunas: Nome, Shopping, Tipo (badge), Telefone, E-mail
- [x] **AC-3:** Coluna "Tipo" com badge: "Gerente de Loja" (azul) | "MKT Shopping" (roxo)
- [x] **AC-4:** Busca por nome, shopping ou e-mail (filtro local, sem nova query)
- [x] **AC-5:** Botão "Exportar CSV" (admin only) gera arquivo com todos os contatos visíveis
- [x] **AC-6:** CSV inclui colunas: Nome, Shopping, Tipo, Telefone, E-mail, Criado em
- [x] **AC-7:** CSV com encoding UTF-8 BOM para compatibilidade com Excel
- [x] **AC-8:** Paginação ou virtualização se > 50 registros (evitar scroll infinito)
- [x] **AC-9:** Viewers veem a lista mas não o botão de exportar
- [x] **AC-10:** Build, lint e typecheck passam sem erros

## Dev Notes

### Dados da Planilha (referência)
A aba "CONTATOS GERENTES DE LOJA" e "CONTATOS MKT SHOPPING" da planilha do cliente têm:
- Shopping, Nome do Contato, Telefone, E-mail
Esses dados já existem na tabela `contacts` do projeto.

### CSV Export
```ts
const exportCSV = (contacts: Contact[]) => {
  const BOM = '\uFEFF'
  const headers = ['Nome', 'Shopping', 'Tipo', 'Telefone', 'Email', 'Criado em']
  const rows = contacts.map(c => [
    c.name,
    c.shopping_name,
    c.contact_type === 'store_manager' ? 'Gerente de Loja' : 'MKT Shopping',
    c.phone || '',
    c.email || '',
    new Date(c.created_at).toLocaleDateString('pt-BR')
  ])
  const csv = BOM + [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n')
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `contatos-${new Date().toISOString().split('T')[0]}.csv`
  a.click()
}
```

### Layout
- Manter tabs existentes (se houver) OU substituir por lista unificada com filtro de tipo
- Preferir lista unificada com badge de tipo para experiência mais simples
- Botão "Exportar CSV" no canto superior direito (admin only)

## Tasks

- [x] **Task 1:** Atualizar `/dashboard/contacts/page.tsx` para exibir lista unificada
- [x] **Task 2:** Adicionar coluna "Tipo" com badge diferenciado
- [x] **Task 3:** Implementar filtro de busca local (nome, shopping, e-mail)
- [x] **Task 4:** Implementar `exportCSV` com UTF-8 BOM
- [x] **Task 5:** Controle de acesso no botão de exportação (admin only)
- [x] **Task 6:** Paginação para listas longas (> 50 itens)
- [x] **Task 7:** Run build, lint, typecheck

## File List
- `src/app/dashboard/contacts/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Status: Implementation Complete

### Completion Notes:
- ✅ Tabs removidas; lista unificada em tabela com colunas Nome, Shopping, Tipo, Telefone, E-mail (AC-1, AC-2)
- ✅ Badge TYPE_BADGE: store_manager=azul, shopping_mkt=roxo (AC-3)
- ✅ Busca useMemo sem nova query, reset de página ao mudar busca (AC-4)
- ✅ exportCSV com UTF-8 BOM, aspas duplas escapadas, `URL.revokeObjectURL` (AC-5, AC-6, AC-7)
- ✅ Paginação de 50 por página com chevrons e contador (AC-8)
- ✅ Botão Exportar CSV visível apenas para `admin` (AC-9)
- ✅ npm run lint: PASS | npx tsc --noEmit: PASS | npm run build: PASS

### Change Log:
- 2026-02-27: Story criada por @architect (Aria)
- 2026-02-27: Implementação completa Story 4.7

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
