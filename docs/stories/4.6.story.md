# Story 4.6: Histórico de Aprovações — Quem Aprovou

## Status: Draft

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de contratos,
**quero** visualizar o histórico completo de quem aprovou, rejeitou ou pulou cada etapa do workflow,
**para** ter rastreabilidade total das decisões e responsabilização por contrato.

## Acceptance Criteria

- [ ] **AC-1:** Em `/dashboard/contracts/[id]/approvals`, cada step card exibe:
  - Nome do usuário que executou a ação (approved_by)
  - Data e hora da ação (`completed_at` formatado em pt-BR)
  - Ação realizada: "Aprovado", "Rejeitado" ou "Pulado"
- [ ] **AC-2:** Botão/ícone "Histórico" no topo da página abre painel lateral (drawer) com todos os eventos registrados em ordem cronológica
- [ ] **AC-3:** Histórico inclui: etapa, usuário, ação, data, nota (se houver)
- [ ] **AC-4:** Usuário exibido com nome completo (join com `profiles`)
- [ ] **AC-5:** Etapas ainda não concluídas não exibem usuário (exibir "—")
- [ ] **AC-6:** Viewers veem o histórico (read-only)
- [ ] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Dados Necessários
A tabela `approval_workflows` já possui:
- `assigned_to` (UUID do usuário)
- `completed_at` (timestamp)
- `step_status` ('approved' | 'rejected' | 'skipped')
- `notes` (observação ao rejeitar)

Adicionar coluna `completed_by UUID REFERENCES profiles(id)` se `assigned_to` não for suficiente.
Alternativa: usar `assigned_to` como `completed_by` (quem foi assigned é quem aprovou).

### Query com Join
```sql
SELECT aw.*, p.full_name AS approver_name
FROM approval_workflows aw
LEFT JOIN profiles p ON aw.assigned_to = p.id
WHERE aw.contract_id = $1
ORDER BY aw.created_at ASC
```

### Drawer de Histórico
```
Histórico de Aprovações — [shopping_name]
─────────────────────────────────────────
✅ Pré-aprovação    João Silva    27/02/2026 14:32
❌ Financeiro       Maria Costa   28/02/2026 09:15   Nota: "Valores incorretos"
⏭️ Diretor          —             —
⏳ Legal            —             —
```

## Tasks

- [ ] **Task 1:** Adicionar `completed_by` em `approval_workflows` se necessário (migração)
- [ ] **Task 2:** Atualizar query para incluir `approver_name` via join com `profiles`
- [ ] **Task 3:** Exibir nome + data no `WorkflowStepCard.tsx` para etapas concluídas
- [ ] **Task 4:** Criar componente `ApprovalHistoryDrawer.tsx`
- [ ] **Task 5:** Adicionar botão "Histórico" na página de approvals
- [ ] **Task 6:** Run build, lint, typecheck

## File List
- `supabase/migrations/YYYYMMDD_add_completed_by_approval.sql` — NEW (se necessário)
- `src/components/dashboard/WorkflowStepCard.tsx` — MODIFIED
- `src/components/dashboard/ApprovalHistoryDrawer.tsx` — NEW
- `src/app/dashboard/contracts/[id]/approvals/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: —
### Status: Draft

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
