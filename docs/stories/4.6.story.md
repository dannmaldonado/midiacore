# Story 4.6: Histórico de Aprovações — Quem Aprovou

## Status: Ready for Review

## Executor Assignment
- **executor:** @dev
- **quality_gate:** @qa
- **quality_gate_tools:** [npm run build, npm run lint, npm run typecheck]

## Story

**Como** gestor de contratos,
**quero** visualizar o histórico completo de quem aprovou, rejeitou ou pulou cada etapa do workflow,
**para** ter rastreabilidade total das decisões e responsabilização por contrato.

## Acceptance Criteria

- [x] **AC-1:** Em `/dashboard/contracts/[id]/approvals`, cada step card exibe:
  - Nome do usuário que executou a ação (approved_by)
  - Data e hora da ação (`completed_at` formatado em pt-BR)
  - Ação realizada: "Aprovado", "Rejeitado" ou "Pulado"
- [x] **AC-2:** Botão/ícone "Histórico" no topo da página abre painel lateral (drawer) com todos os eventos registrados em ordem cronológica
- [x] **AC-3:** Histórico inclui: etapa, usuário, ação, data, nota (se houver)
- [x] **AC-4:** Usuário exibido com nome completo (join com `profiles`)
- [x] **AC-5:** Etapas ainda não concluídas não exibem usuário (exibir "—")
- [x] **AC-6:** Viewers veem o histórico (read-only)
- [x] **AC-7:** Build, lint e typecheck passam sem erros

## Dev Notes

### Dados Necessários
A tabela `approval_workflows` já possui:
- `assigned_to` (UUID do usuário)
- `completed_at` (timestamp)
- `step_status` ('approved' | 'rejected' | 'skipped')
- `notes` (observação ao rejeitar)

Adicionar coluna `completed_by UUID REFERENCES profiles(id)` se `assigned_to` não for suficiente.
Alternativa: usar `assigned_to` como `completed_by` (quem foi assigned é quem aprovou).

### Query com Join
```sql
SELECT aw.*, p.full_name AS approver_name
FROM approval_workflows aw
LEFT JOIN profiles p ON aw.assigned_to = p.id
WHERE aw.contract_id = $1
ORDER BY aw.created_at ASC
```

### Drawer de Histórico
```
Histórico de Aprovações — [shopping_name]
─────────────────────────────────────────
✅ Pré-aprovação    João Silva    27/02/2026 14:32
❌ Financeiro       Maria Costa   28/02/2026 09:15   Nota: "Valores incorretos"
⏭️ Diretor          —             —
⏳ Legal            —             —
```

## Tasks

- [x] **Task 1:** Adicionar `completed_by` em `approval_workflows` se necessário (migração)
- [x] **Task 2:** Atualizar query para incluir `approver_name` via join com `profiles`
- [x] **Task 3:** Exibir nome + data no `WorkflowStepCard.tsx` para etapas concluídas
- [x] **Task 4:** Criar componente `ApprovalHistoryDrawer.tsx`
- [x] **Task 5:** Adicionar botão "Histórico" na página de approvals
- [x] **Task 6:** Run build, lint, typecheck

## File List
- `src/components/dashboard/WorkflowStepCard.tsx` — MODIFIED
- `src/components/dashboard/ApprovalWorkflow.tsx` — MODIFIED
- `src/components/dashboard/ApprovalHistoryDrawer.tsx` — NEW
- `src/app/dashboard/contracts/[id]/approvals/page.tsx` — MODIFIED

## Dev Agent Record

### Agent Model Used: claude-sonnet-4-6
### Status: Implementation Complete

### Completion Notes:
- ✅ Migração não necessária: `assigned_to` usado como `completed_by` (quem foi atribuído executou a ação)
- ✅ `WorkflowStepCard.tsx`: seção "Executado por" exibe `assignedProfile.full_name` e `completed_at` formatado (AC-1)
- ✅ `ApprovalHistoryDrawer.tsx`: drawer lateral com timeline cronológica, STEP_LABELS para 12 etapas + internas, STATUS_CONFIG com ícones/cores, nota de rejeição em destaque (AC-2, AC-3, AC-4, AC-5)
- ✅ `ApprovalWorkflow.tsx`: botão "Histórico" na barra de progresso, prop `contractName`, estado `showHistory`, render do drawer (AC-2, AC-6)
- ✅ `approvals/page.tsx`: passa `contractName={contract.shopping_name}` ao ApprovalWorkflow
- ✅ npm run lint: PASS
- ✅ npx tsc --noEmit: PASS
- ✅ npm run build: PASS

### Change Log:
- 2026-02-27: Story criada por @architect (Aria) com base nas solicitações do cliente
- 2026-02-27: Implementação completa Story 4.6

---

## QA Results

### Reviewed By: —
### Gate Decision: PENDING
